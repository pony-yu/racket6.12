<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>16.2.7&nbsp;Syntax Taints</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Racket&#25351;&#21335;</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="intro.html" class="tocviewlink" data-pltdoc="x">Racket&#35821;&#35328;&#27426;&#36814;&#20320;!</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="to-scheme.html" class="tocviewlink" data-pltdoc="x">Racket Essentials</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="datatypes.html" class="tocviewlink" data-pltdoc="x">Built-<wbr></wbr>In Datatypes</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="scheme-forms.html" class="tocviewlink" data-pltdoc="x">Expressions and Definitions</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="define-struct.html" class="tocviewlink" data-pltdoc="x">Programmer-<wbr></wbr>Defined Datatypes</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="modules.html" class="tocviewlink" data-pltdoc="x">Modules</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="contracts.html" class="tocviewlink" data-pltdoc="x">Contracts</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="i_o.html" class="tocviewlink" data-pltdoc="x">Input and Output</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="regexp.html" class="tocviewlink" data-pltdoc="x">Regular Expressions</a></td></tr><tr><td align="right">10&nbsp;</td><td><a href="control.html" class="tocviewlink" data-pltdoc="x">Exceptions and Control</a></td></tr><tr><td align="right">11&nbsp;</td><td><a href="for.html" class="tocviewlink" data-pltdoc="x">Iterations and Comprehensions</a></td></tr><tr><td align="right">12&nbsp;</td><td><a href="match.html" class="tocviewlink" data-pltdoc="x">Pattern Matching</a></td></tr><tr><td align="right">13&nbsp;</td><td><a href="classes.html" class="tocviewlink" data-pltdoc="x">Classes and Objects</a></td></tr><tr><td align="right">14&nbsp;</td><td><a href="units.html" class="tocviewlink" data-pltdoc="x">Units</a></td></tr><tr><td align="right">15&nbsp;</td><td><a href="reflection.html" class="tocviewlink" data-pltdoc="x">Reflection and Dynamic Evaluation</a></td></tr><tr><td align="right">16&nbsp;</td><td><a href="macros.html" class="tocviewselflink" data-pltdoc="x">Macros</a></td></tr><tr><td align="right">17&nbsp;</td><td><a href="languages.html" class="tocviewlink" data-pltdoc="x">&#21019;&#36896;&#35821;&#35328;</a></td></tr><tr><td align="right">18&nbsp;</td><td><a href="concurrency.html" class="tocviewlink" data-pltdoc="x">&#24182;&#21457;&#19982;&#21516;&#27493;</a></td></tr><tr><td align="right">19&nbsp;</td><td><a href="performance.html" class="tocviewlink" data-pltdoc="x">&#24615;&#33021;</a></td></tr><tr><td align="right">20&nbsp;</td><td><a href="parallelism.html" class="tocviewlink" data-pltdoc="x">&#24182;&#34892;</a></td></tr><tr><td align="right">21&nbsp;</td><td><a href="running.html" class="tocviewlink" data-pltdoc="x">Running and Creating Executables</a></td></tr><tr><td align="right">22&nbsp;</td><td><a href="More_Libraries.html" class="tocviewlink" data-pltdoc="x">More Libraries</a></td></tr><tr><td align="right">23&nbsp;</td><td><a href="dialects.html" class="tocviewlink" data-pltdoc="x">Dialects of Racket and Scheme</a></td></tr><tr><td align="right">24&nbsp;</td><td><a href="other-editors.html" class="tocviewlink" data-pltdoc="x">Command-<wbr></wbr>Line Tools and Your Editor of Choice</a></td></tr><tr><td align="right"></td><td><a href="doc-bibliography.html" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>16&nbsp;</td><td><a href="macros.html" class="tocviewlink" data-pltdoc="x">Macros</a></td></tr></table><div class="tocviewsublist" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">16.1&nbsp;</td><td><a href="pattern-macros.html" class="tocviewlink" data-pltdoc="x">Pattern-<wbr></wbr>Based Macros</a></td></tr><tr><td align="right">16.2&nbsp;</td><td><a href="proc-macros.html" class="tocviewselflink" data-pltdoc="x">General Macro Transformers</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_2&quot;);">&#9660;</a></td><td>16.2&nbsp;</td><td><a href="proc-macros.html" class="tocviewlink" data-pltdoc="x">General Macro Transformers</a></td></tr></table><div class="tocviewsublist" style="display: block;" id="tocview_2"><table cellspacing="0" cellpadding="0"><tr><td align="right">16.2.1&nbsp;</td><td><a href="stx-obj.html" class="tocviewlink" data-pltdoc="x">Syntax Objects</a></td></tr><tr><td align="right">16.2.2&nbsp;</td><td><a href="macro-transformers.html" class="tocviewlink" data-pltdoc="x">Macro Transformer Procedures</a></td></tr><tr><td align="right">16.2.3&nbsp;</td><td><a href="syntax-case.html" class="tocviewlink" data-pltdoc="x">Mixing Patterns and Expressions:<span class="mywbr"> &nbsp;</span> <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-<wbr></wbr>case</span></span></span></a></td></tr><tr><td align="right">16.2.4&nbsp;</td><td><a href="with-syntax.html" class="tocviewlink" data-pltdoc="x"><span class="RktSym"><span class="badlink"><span class="RktValLink">with-<wbr></wbr>syntax</span></span></span> and <span class="RktSym"><span class="badlink"><span class="RktValLink">generate-<wbr></wbr>temporaries</span></span></span></a></td></tr><tr><td align="right">16.2.5&nbsp;</td><td><a href="stx-phases.html" class="tocviewlink" data-pltdoc="x">Compile and Run-<wbr></wbr>Time Phases</a></td></tr><tr><td align="right">16.2.6&nbsp;</td><td><a href="phases.html" class="tocviewlink" data-pltdoc="x">General Phase Levels</a></td></tr><tr><td align="right">16.2.7&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Syntax Taints</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_3&quot;);">&#9658;</a></td><td>16.2.7&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Syntax Taints</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_3"><table cellspacing="0" cellpadding="0"><tr><td align="right">16.2.7.1&nbsp;</td><td><a href="#%28part._.Tainting_.Modes%29" class="tocviewlink" data-pltdoc="x">Tainting Modes</a></td></tr><tr><td align="right">16.2.7.2&nbsp;</td><td><a href="#%28part._taints%2Bcode-inspectors%29" class="tocviewlink" data-pltdoc="x">Taints and Code Inspectors</a></td></tr><tr><td align="right">16.2.7.3&nbsp;</td><td><a href="#%28part._code-inspectors%2Bprotect%29" class="tocviewlink" data-pltdoc="x">Protected Exports</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">16.2.7.1<tt>&nbsp;</tt></span><a href="#%28part._.Tainting_.Modes%29" class="tocsubseclink" data-pltdoc="x">Tainting Modes</a></td></tr><tr><td><span class="tocsublinknumber">16.2.7.2<tt>&nbsp;</tt></span><a href="#%28part._taints%2Bcode-inspectors%29" class="tocsubseclink" data-pltdoc="x">Taints and Code Inspectors</a></td></tr><tr><td><span class="tocsublinknumber">16.2.7.3<tt>&nbsp;</tt></span><a href="#%28part._code-inspectors%2Bprotect%29" class="tocsubseclink" data-pltdoc="x">Protected Exports</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="phases.html" title="backward to &quot;16.2.6 General Phase Levels&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="proc-macros.html" title="up to &quot;16.2 General Macro Transformers&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="languages.html" title="forward to &quot;17 创造语言&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h5>16.2.7<tt>&nbsp;</tt><a name="(part._stx-certs)"></a>Syntax Taints</h5><p>A use of a macro can expand into a use of an identifier that is not
exported from the module that binds the macro. In general, such an
identifier must not be extracted from the expanded expression and used
in a different context, because using the identifier in a different
context may break invariants of the macro&rsquo;s module.</p><p>For example, the following module exports a macro <span class="RktSym">go</span> that
expands to a use of <span class="RktSym">unchecked-go</span>:</p><blockquote class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"m.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><font class="badlink"><span class="RktModLink"><span class="RktMod">#lang</span></span></font><span class="hspace">&nbsp;</span><font class="badlink"><span class="RktModLink"><span class="RktSym">racket</span></span></font></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">to avoid disaster, </span><span class="RktSym">n</span><span class="RktCmt"> must be a number</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">+</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktVal">17</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktVal">8</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></blockquote></blockquote><p>If the reference to <span class="RktSym">unchecked-go</span> is extracted from the
expansion of <span class="RktPn">(</span><span class="RktSym">go</span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">a</span><span class="RktPn">)</span>, then it might be inserted into a new
expression, <span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="stt"> </span><span class="RktVal">#f</span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">a</span><span class="RktPn">)</span>, leading to disaster. The
<span class="RktSym"><span class="badlink"><span class="RktValLink">datum-&gt;syntax</span></span></span> procedure can be used similarly to construct
references to an unexported identifier, even when no macro expansion
includes a reference to the identifier.</p><p>To prevent such abuses of unexported identifiers, the <span class="RktSym">go</span>
macro must explicitly protect its expansion by using
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktVal">8</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span> function causes any syntax object that is
extracted from the result of <span class="RktSym">go</span> to be <a name="(tech._tainted)"></a><span style="font-style: italic">tainted</span>.  The
macro expander rejects tainted identifiers, so attempting to extract
<span class="RktSym">unchecked-go</span> from the expansion of <span class="RktPn">(</span><span class="RktSym">go</span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">a</span><span class="RktPn">)</span> produces
an identifier that cannot be used to construct a new expression (or, at
least, not one that the macro expander will accept). The
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-rules</span></span></span>, <span class="RktSym">syntax-id-rule</span>, and
<span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax-rule</span></span></span> forms automatically protect their
expansion results.</p><p>More precisely, <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span> <a name="(tech._arm)"></a><span style="font-style: italic">arms</span> a syntax object
with a <a name="(tech._dye._pack)"></a><span style="font-style: italic">dye pack</span>. When a syntax object is armed, then
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-e</span></span></span> taints any syntax object in its result. Similarly,
<span class="RktSym"><span class="badlink"><span class="RktValLink">datum-&gt;syntax</span></span></span> taints its result when its first argument is
armed. Finally, if any part of a quoted syntax object is armed, then
the corresponding part is tainted in the resulting syntax constant.</p><p>Of course, the macro expander itself must be able to <a name="(tech._disarm)"></a><span style="font-style: italic">disarm</span>
a taint on a syntax object, so that it can further expand an
expression or its sub-expressions. When a syntax object is armed with
a dye pack, the dye pack has an associated inspector that can be used
to disarm the dye pack. A <span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span><span class="stt"> </span><span class="RktVar">stx</span><span class="RktPn">)</span> function call
is actually a shorthand for <span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-arm</span></span></span><span class="stt"> </span><span class="RktVar">stx</span><span class="stt"> </span><span class="RktVal">#f</span><span class="stt"> </span><span class="RktVal">#t</span><span class="RktPn">)</span>, which
arms <span class="RktVar">stx</span> using a suitable inspector. The expander uses
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-disarm</span></span></span> and with its inspector on every expression
before trying to expand or compile it.</p><p>In much the same way that the macro expander copies properties from a
syntax transformer&rsquo;s input to its output (see <font class="badlink">(part ("(lib scribblings/reference/reference.scrbl)" "stxprops"))</font>),
the expander copies dye packs from a transformer&rsquo;s input to its
output. Building on the previous example,</p><blockquote class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"n.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><font class="badlink"><span class="RktModLink"><span class="RktMod">#lang</span></span></font><span class="hspace">&nbsp;</span><font class="badlink"><span class="RktModLink"><span class="RktSym">racket</span></span></font></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">require</span></span></span><span class="hspace">&nbsp;</span><span class="RktVal">"m.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">go-more</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">y</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">hello</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go-more</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="hspace">&nbsp;</span><span class="RktSym">y</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></blockquote></blockquote><p>the expansion of <span class="RktPn">(</span><span class="RktSym">go-more</span><span class="RktPn">)</span> introduces a reference to the
unexported <span class="RktSym">y</span> in <span class="RktPn">(</span><span class="RktSym">go</span><span class="stt"> </span><span class="RktSym">y</span><span class="RktPn">)</span>, and the expansion result is
armed so that <span class="RktSym">y</span> cannot be extracted from the expansion.  Even
if <span class="RktSym">go</span> did not use <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span> for its result
(perhaps because it does not need to protect <span class="RktSym">unchecked-go</span>
after all), the dye pack on <span class="RktPn">(</span><span class="RktSym">go</span><span class="stt"> </span><span class="RktSym">y</span><span class="RktPn">)</span> is propagated to the final
expansion <span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="stt"> </span><span class="RktVal">8</span><span class="stt"> </span><span class="RktSym">y</span><span class="RktPn">)</span>. The macro expander uses
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-rearm</span></span></span> to propagate dye packs from a transformer&rsquo;s
input to its output.</p><h5>16.2.7.1<tt>&nbsp;</tt><a name="(part._.Tainting_.Modes)"></a>Tainting Modes</h5><p>In some cases, a macro implementor intends to allow limited
destructuring of a macro result without tainting the result.
For example, given the following <span class="RktSym">define-like-y</span>
macro,</p><blockquote class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"q.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><font class="badlink"><span class="RktModLink"><span class="RktMod">#lang</span></span></font><span class="hspace">&nbsp;</span><font class="badlink"><span class="RktModLink"><span class="RktSym">racket</span></span></font></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">define-like-y</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">y</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">hello</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">define-like-y</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">id</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">id</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">y</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></blockquote></blockquote><p>someone may use the macro in an internal definition:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">let</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">define-like-y</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The implementor of the <span class="stt">"q.rkt"</span> module most likely intended to allow
such uses of <span class="RktSym">define-like-y</span>. To convert an internal definition
into a <span class="RktSym"><span class="badlink"><span class="RktValLink">letrec</span></span></span> binding, however, the <span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span> form
produced by <span class="RktSym">define-like-y</span> must be deconstructed, which would
normally taint both the binding <span class="RktSym">x</span> and the reference to
<span class="RktSym">y</span>.</p><p>Instead, the internal use of <span class="RktSym">define-like-y</span> is allowed,
because <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span> treats specially a syntax list that
begins with <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>. In that case, instead of arming
the overall expression, each individual element of the syntax list is
armed, pushing dye packs further into the second element of the list so
that they are attached to the defined identifiers. Thus,
<span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>, <span class="RktSym">x</span>, and <span class="RktSym">y</span> in the expansion
result <span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="stt"> </span><span class="RktSym">y</span><span class="RktPn">)</span> are individually armed, and the
definition can be deconstructed for conversion to <span class="RktSym"><span class="badlink"><span class="RktValLink">letrec</span></span></span>.</p><p>Just like <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span>, the expander rearms a transformer
result that starts with <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>, by pushing dye packs
into the list elements. As a result, <span class="RktSym">define-like-y</span> could have
been implemented to produce <span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="stt"> </span><span class="RktSym">id</span><span class="stt"> </span><span class="RktSym">y</span><span class="RktPn">)</span>, which uses
<span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span> instead of <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>. In that case, the
entire <span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span> form is at first armed with a dye pack, but as the
<span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span> form is expanded to <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>, the dye
pack is moved to the parts.</p><p>The macro expander treats syntax-list results starting with
<span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntaxes</span></span></span> in the same way that it treats results
starting with <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span>. Syntax-list results starting
with <span class="RktSym"><span class="badlink"><span class="RktValLink">begin</span></span></span> are treated similarly, except that the second
element of the syntax list is treated like all the other elements
(i.e., the immediate element is armed, instead of its
content). Furthermore, the macro expander applies this special
handling recursively, in case a macro produces a <span class="RktSym"><span class="badlink"><span class="RktValLink">begin</span></span></span> form
that contains nested <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span> forms.</p><p>The default application of dye packs can be overridden by attaching
a <span class="RktVal">'</span><span class="RktVal">taint-mode</span> property (see <font class="badlink">(part ("(lib scribblings/reference/reference.scrbl)" "stxprops"))</font>) to the
resulting syntax object of a macro transformer. If the property value is
<span class="RktVal">'</span><span class="RktVal">opaque</span>, then the syntax object is armed and not its
parts. If the property value is <span class="RktVal">'</span><span class="RktVal">transparent</span>, then the
syntax object&rsquo;s parts are armed. If the property value is
<span class="RktVal">'</span><span class="RktVal">transparent-binding</span>, then the syntax object&rsquo;s parts and
the sub-parts of the second part (as for <span class="RktSym"><span class="badlink"><span class="RktValLink">define-values</span></span></span> and
<span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntaxes</span></span></span>) are armed. The <span class="RktVal">'</span><span class="RktVal">transparent</span> and
<span class="RktVal">'</span><span class="RktVal">transparent-binding</span> modes trigger recursive property
checking at the parts, so that armings can be pushed arbitrarily deeply
into a transformer&rsquo;s result.</p><h5>16.2.7.2<tt>&nbsp;</tt><a name="(part._taints+code-inspectors)"></a>Taints and Code Inspectors</h5><p>Tools that are intended to be privileged (such as a debugging
transformer) must disarm dye packs in expanded programs.  Privilege is
granted through <a name="(tech._code._inspector)"></a><span style="font-style: italic">code inspectors</span>. Each dye pack records an
inspector, and a syntax object can be disarmed using a sufficiently
powerful inspector.</p><p>When a module is declared, the declaration captures the current value
of the <span class="RktSym"><span class="badlink"><span class="RktValLink">current-code-inspector</span></span></span> parameter.  The captured
inspector is used when <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span> is applied by a macro
transformer that is defined within the module. A tool can disarm the
resulting syntax object by supplying <span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-disarm</span></span></span> with
an inspector that is the same or a super-inspector of the module&rsquo;s
inspector. Untrusted code is ultimately run after setting
<span class="RktSym"><span class="badlink"><span class="RktValLink">current-code-inspector</span></span></span> to a less powerful inspector (after
trusted code, such as debugging tools, have been loaded).</p><p>With this arrangement, macro-generating macros require some care,
since the generating macro may embed syntax objects in the generated
macro that need to have the generating module&rsquo;s protection level,
rather than the protection level of the module that contains the
generated macro. To avoid this problem, use the module&rsquo;s
declaration-time inspector, which is accessible as
<span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">variable-reference-&gt;module-declaration-inspector</span></span></span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">#%variable-reference</span></span></span><span class="RktPn">)</span><span class="RktPn">)</span>, and use it to define a variant of
<span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-protect</span></span></span>.</p><p>For example, suppose that the <span class="RktSym">go</span> macro is implemented through
a macro:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><font class="badlink"><span class="RktModLink"><span class="RktMod">#lang</span></span></font><span class="hspace">&nbsp;</span><font class="badlink"><span class="RktModLink"><span class="RktSym">racket</span></span></font></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">def-go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">+</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktVal">17</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">def-go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">protect-syntax</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">protect-syntax</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktVal">8</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>When <span class="RktSym">def-go</span> is used inside another module to define
<span class="RktSym">go</span>, and when the <span class="RktSym">go</span>-defining module is at a
different protection level than the <span class="RktSym">def-go</span>-defining module, the
generated macro&rsquo;s use of <span class="RktSym">protect-syntax</span> is not right.  The
use of <span class="RktSym">unchecked-go</span> should be protected at the level of the
<span class="RktSym">def-go</span>-defining module, not the <span class="RktSym">go</span>-defining module.</p><p>The solution is to define and use <span class="RktSym">go-syntax-protect</span>, instead:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><font class="badlink"><span class="RktModLink"><span class="RktMod">#lang</span></span></font><span class="hspace">&nbsp;</span><font class="badlink"><span class="RktModLink"><span class="RktSym">racket</span></span></font></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">def-go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">+</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktVal">17</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-for-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">go-syntax-protect</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">let</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">insp</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">variable-reference-&gt;module-declaration-inspector</span></span></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">#%variable-reference</span></span></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">lambda</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">stx</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-arm</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktSym">insp</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">def-go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">go</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">protect-syntax</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">define-syntax</span></span></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">syntax-case</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="badlink"><span class="RktValLink">_</span></span></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">go-syntax-protect</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">unchecked-go</span><span class="hspace">&nbsp;</span><span class="RktVal">8</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><h5>16.2.7.3<tt>&nbsp;</tt><a name="(part._code-inspectors+protect)"></a>Protected Exports</h5><p>Sometimes, a module needs to export bindings to some modules&#8212;<wbr></wbr>other
modules that are at the same trust level as the exporting module&#8212;<wbr></wbr>but
prevent access from untrusted modules. Such exports should use the
<span class="RktSym"><span class="badlink"><span class="RktValLink">protect-out</span></span></span> form in <span class="RktSym"><span class="badlink"><span class="RktValLink">provide</span></span></span>. For example,
<span class="RktSym">ffi/unsafe</span> exports all of its unsafe bindings as
<a name="(tech._protected)"></a><span style="font-style: italic">protected</span> in this sense.</p><p>Code inspectors, again, provide the mechanism for determining which
modules are trusted and which are untrusted. When a module is
declared, the value of <span class="RktSym"><span class="badlink"><span class="RktValLink">current-code-inspector</span></span></span> is associated
to the module declaration. When a module is instantiated (i.e., when the
body of the declaration is actually executed), a sub-inspector is
created to guard the module&rsquo;s exports. Access to the module&rsquo;s
<a href="#%28tech._protected%29" class="techoutside" data-pltdoc="x"><span class="techinside">protected</span></a> exports requires a code inspector higher in the
inspector hierarchy than the module&rsquo;s instantiation inspector; note
that a module&rsquo;s declaration inspector is always higher than its
instantiation inspector, so modules are declared with the same code
inspector can access each other&rsquo;s exports.</p><p>Syntax-object constants within a module, such as literal identifiers
in a template, retain the inspector of their source module. In this
way, a macro from a trusted module can be used within an untrusted
module, and <a href="#%28tech._protected%29" class="techoutside" data-pltdoc="x"><span class="techinside">protected</span></a> identifiers in the macro expansion still
work, even through they ultimately appear in an untrusted
module. Naturally, such identifiers should be <a href="#%28tech._arm%29" class="techoutside" data-pltdoc="x"><span class="techinside">arm</span></a>ed, so that
they cannot be extracted from the macro expansion and abused by
untrusted code.</p><p>Compiled code from a <span class="stt">".zo"</span> file is inherently untrustworthy,
unfortunately, since it can be synthesized by means other than
<span class="RktSym"><span class="badlink"><span class="RktValLink">compile</span></span></span>. When compiled code is written to a <span class="stt">".zo"</span>
file, syntax-object constants within the compiled code lose their
inspectors. All syntax-object constants within compiled code acquire
the enclosing module&rsquo;s declaration-time inspector when the code is
loaded.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="phases.html" title="backward to &quot;16.2.6 General Phase Levels&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="proc-macros.html" title="up to &quot;16.2 General Macro Transformers&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="languages.html" title="forward to &quot;17 创造语言&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>